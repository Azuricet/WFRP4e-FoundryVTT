<form>
  <div class="stage-title">
    <p>Determine Attributes</p>
  </div>

  <div class="chargen-content">

    {{#if (eq context.step 0)}}
    <div class="buttons">
      <a class='chargen-button' data-button='rollAttributes'>{{localize "Roll"}}</a>
    </div>

    {{else}}


    <div class="flexcol ch-rolls">
      <div class="flexrow">
        <strong class="flex2">Characteristic</strong>
        <strong>Formula</strong>
        <strong>Roll</strong>
        <strong>Total</strong>
      </div>
      
        {{#each context.characteristics as |characteristic key|}}
        <div class="flexrow allocation-input">
          <span class="flex2">{{configLookup "characteristics" key}}</span>
          <span>{{characteristic.formula}}</span>
          {{#if (eq ../context.step 4)}}
          <span class="ch-allocate-container">
            <input class="ch-allocate" data-ch="{{key}}" type="number" value="{{characteristic.allocated}}">
          </span>
          {{else}}
          <a class="ch-roll" data-ch="{{key}}">{{characteristic.roll}}</a>
          {{/if}}
          <span>{{characteristic.total}}</span>
        </div>
        {{/each}}
      </div>

      {{#unless (eq context.step 4)}}
      <p class="centered">Drag and drop the Roll values to rearrange the stats as desired (but doing so provides less XP).</p>
      {{/unless}}

      <p class="centered">Alternatively, you can reroll and receive no XP.</p>
      <div class="buttons">
        <a class='chargen-button' data-button='reroll'>{{localize "CHARGEN.Reroll"}}</a>
      </div>
      {{#unless (eq context.step 4)}}
      <p class="centered">Alternatively, you can allocate 100 points as you wish.</p>
      <div class="buttons">
        <a class='chargen-button' data-button='allocate'>{{localize "CHARGEN.Allocate"}}</a>
      </div>
      {{/unless}}
      {{#if (eq context.step 4)}}
      <p>Allocate 100 Points to characteristics (min. 4, max: 18)</p>
      <p>You have spent {{context.allocation.spent}}</p>
      {{/if}}
      

      <p class="centered">Allocate Extra Points ({{context.meta.left}} left)</p>
      <div class="meta flexrow">
        <div class="flexcol allocation-input">
          <h4>Fate ({{context.meta.fate.total}})</h4>
          <input data-meta="fate" type="number"  value="{{context.meta.fate.allotted}}">
        </div>
        <div class="flexcol allocation-input">
          <h4>Resilience ({{context.meta.resilience.total}})</h4>
          <input data-meta="resilience" type="number" value="{{context.meta.resilience.allotted}}">
        </div>
      </div>

      <p class="centered">Allocate 5 Advances to your Career's characteristics</p>
      <div class="flexrow">
        {{#each data.items.career.system.characteristics as |characteristic ch|}}
        <div class="flexcol allocation-input">
            <h4>{{configLookup "characteristics" characteristic}}</h4>
            {{#with (lookup ../context.characteristics characteristic)}}
            <input class="ch-advance" value="{{advances}}" data-ch="{{../this}}" type="number">
            {{/with}}
        </div>
          {{/each}}
      </div>
    </div>
    {{/if}}
  </div>

    <div class="result">
      <div></div>
      <span class="xp">XP: {{context.exp}}</span>
    </div>
    <div class="controls">
      <button type="submit">{{localize "Submit"}}</button>
    </div>
</form>